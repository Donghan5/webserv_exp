<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webserv Modern Website</title>
    <link rel="stylesheet" href="style.css">
    <script src="script.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <h1>ğŸš€ Webserv</h1>
        <nav>
            <ul>
                <li><a href="index.html">ğŸ  HOME</a></li>
                <li><a href="about.html">â„¹ï¸ ABOUT</a></li>
                <li><a href="contact.html">ğŸ“ CONTACT</a></li>
            </ul>
        </nav>
    </header>

    <section class="hero">
        <h2>WELCOME TO WEBSERV âœ¨</h2>
        <p>THIS WEBSITE SERVED AS WEBSERV</p>
    </section>

    <!-- ğŸ“¤ POST: íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="container">
        <h1>ğŸ“¤ Upload File (POST)</h1>
        <input type="file" id="fileInput">
        <button class="btn-primary" onclick="uploadFile()">Upload</button>
        <p id="upload-status"></p>
    </div>

    <!-- ğŸ—‘ï¸ DELETE: íŒŒì¼ ì‚­ì œ -->
    <div class="container">
        <h1>ğŸ—‘ï¸ Delete File (DELETE)</h1>
        <input type="text" id="deleteFileName" placeholder="Enter filename to delete">
        <button class="btn-danger" onclick="deleteFile()">Delete</button>
        <p id="delete-status"></p>
    </div>

    <!-- ğŸ” GET: íŠ¹ì • íŒŒì¼ ì¡°íšŒ -->
    <div class="container">
        <h1>ğŸ“„ View File (GET)</h1>
        <input type="text" id="getFileName" placeholder="Enter filename">
        <button class="btn-secondary" onclick="getFile()">View</button>
        <p id="get-status"></p>
        <img id="preview-image" style="max-width: 100%; display: none;" />
    </div>

    <!-- âš¡ CGI í…ŒìŠ¤íŠ¸ -->
    <div class="container">
        <h1>âš¡ CGI Test</h1>
        <button class="btn-secondary" onclick="runCGI('/cgi-bin/test.py')">Run Python CGI ğŸ</button>
        <button class="btn-secondary" onclick="runCGI('/cgi-bin/test.php')">Run PHP CGI ğŸ˜</button>
        <button class="btn-secondary" onclick="runCGI('/cgi-bin/test.pl')">Run Perl CGI ğŸª</button>
        <button class="btn-secondary" onclick="runCGI('/cgi-bin/test.sh')">Run Bash CGI ğŸ–¥ï¸</button>
        <p id="cgi-output">ğŸ“„ CGI output will be displayed here.</p>
    </div>

    <!-- ğŸª ì¿ í‚¤ í…ŒìŠ¤íŠ¸ -->
    <div class="container">
        <h1>ğŸª Cookie Test</h1>
        <button class="btn-primary" onclick="runCookieTest()">Run Cookie Test</button>
        <p id="cookie-status">Result displayed.</p>
        <div id="cookie-info" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; display: none;">
            <h3>Current info of Cookie</h3>
            <pre id="current-cookies"></pre>
            <p><small>* It maintain in the next visit.</small></p>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 WEBSERV PROJECT</p>
    </footer>

    <script>
        function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a file to upload.");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            fetch("/upload/" + file.name, {
                method: "POST",
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById("upload-status").innerText = "âœ… Upload Successful!";
            })
            .catch(error => {
                document.getElementById("upload-status").innerText = "âŒ Upload Failed!";
            });
        }

        function deleteFile() {
            const fileName = document.getElementById("deleteFileName").value;
            if (!fileName) {
                alert("Please enter a filename to delete.");
                return;
            }

            fetch("/upload/" + fileName, { method: "DELETE" })
            .then(response => response.text())
            .then(data => {
                document.getElementById("delete-status").innerText = "âœ… File Deleted!";
            })
            .catch(error => {
                document.getElementById("delete-status").innerText = "âŒ Delete Failed!";
            });
        }

        function getFile() {
            const fileName = document.getElementById("getFileName").value;
            if (!fileName) {
                alert("Please enter a filename.");
                return;
            }

            fetch("/upload/" + fileName)
            .then(response => {
                if (!response.ok) {
                    throw new Error("File not found!");
                }
                return response.blob();
            })
            .then(blob => {
                const fileType = blob.type;
                const url = URL.createObjectURL(blob);

                if (fileType.startsWith("image/")) {
                    document.getElementById("preview-image").src = url;
                    document.getElementById("preview-image").style.display = "block";
                } else {
                    window.open(url, "_blank");
                }
                document.getElementById("get-status").innerText = "âœ… File retrieved!";
            })
            .catch(error => {
                document.getElementById("get-status").innerText = "âŒ File not found!";
            });
        }

        function runCGI(cgiPath) {
            fetch(cgiPath)
            .then(response => response.text())
            .then(data => {
                document.getElementById("cgi-output").innerText = "âœ… CGI Output:\n" + data;
            })
            .catch(error => {
                document.getElementById("cgi-output").innerText = "âŒ CGI Execution Failed!";
            });
        }

        function runCookieTest() {
            // ìƒíƒœ ì—…ë°ì´íŠ¸
            const statusEl = document.getElementById("cookie-status");
            statusEl.innerText = "ğŸ”„ testing Cookie feature...";

            // cookie.py CGI ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            fetch('/cgi-bin/cookie.py')
            .then(response => {
                // ì‘ë‹µ í—¤ë”ì—ì„œ ì¿ í‚¤ ì •ë³´ í™•ì¸
                const setCookie = response.headers.get('set-cookie');

                return response.text().then(data => {
                    return { text: data, cookie: setCookie };
                });
            })
            .then(data => {
                // ì¿ í‚¤ í…ŒìŠ¤íŠ¸ ê²°ê³¼ í‘œì‹œ
                statusEl.innerHTML = "âœ… Complete! Updated visit time.";

                // í˜„ì¬ ëª¨ë“  ì¿ í‚¤ ì •ë³´ í‘œì‹œ
                displayCurrentCookies();

                // iframeìœ¼ë¡œ ê²°ê³¼ í‘œì‹œ (HTML ë‚´ìš©ì´ ìˆëŠ” ê²½ìš°)
                if (data.text && data.text.includes("<html")) {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '300px';
                    iframe.style.border = '1px solid #ddd';
                    iframe.style.borderRadius = '4px';
                    iframe.style.marginTop = '10px';

                    // HTML ë‚´ìš© ì‚½ì…
                    iframe.srcdoc = data.text;

                    // ê¸°ì¡´ iframe ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
                    const existingIframe = document.querySelector('#cookie-status iframe');
                    if (existingIframe) {
                        existingIframe.remove();
                    }

                    statusEl.appendChild(iframe);
                }
            })
            .catch(error => {
                statusEl.innerText = "âŒ Failed cookie test: " + error.message;
            });
        }

        function displayCurrentCookies() {
			const cookieInfo = document.getElementById("cookie-info");
			const currentCookies = document.getElementById("current-cookies");

			// ì¿ í‚¤ ì •ë³´ ë°•ìŠ¤ í‘œì‹œ
			cookieInfo.style.display = "block";

			// í˜„ì¬ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ëª¨ë“  ì¿ í‚¤ ê°€ì ¸ì˜¤ê¸°
			const allCookies = document.cookie.split(';').map(cookie => cookie.trim());

			if (allCookies.length === 0 || (allCookies.length === 1 && allCookies[0] === "")) {
				currentCookies.textContent = "ì €ì¥ëœ ì¿ í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤.";
				return;
			}

			// ì¿ í‚¤ ì •ë³´ ì˜ˆì˜ê²Œ í‘œì‹œ - ìˆ˜ì •ëœ ë¶€ë¶„
			const cookieData = {};
			allCookies.forEach(cookie => {
				if (cookie && cookie.includes('=')) {
					const parts = cookie.split('=');
					if (parts.length >= 2) {
						const name = parts[0].trim();
						const value = parts.slice(1).join('=');

						if (name && name !== "undefined") {
							cookieData[name] = value;
						}
					}
				}
			});

			currentCookies.textContent = JSON.stringify(cookieData, null, 2);
		}

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¿ í‚¤ ì •ë³´ í‘œì‹œ
        window.addEventListener('load', function() {
            displayCurrentCookies();
        });
    </script>
</body>
</html>
